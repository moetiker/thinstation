#!/bin/bash

gzname=`basename $1`
tarname=`basename $1 .tar.gz`
filename=`basename $1 .tar.gz`
INSTALLDIR=./packages/thinlinc

tar -C wget_tmp -zxf ./wget_tmp/$gzname
let returnval=$?

chmod -R u+w ./wget_tmp
cp -Prf ./wget_tmp/packages/thinlinc/* $INSTALLDIR/.

mv $INSTALLDIR/usr/icons $INSTALLDIR/lib/pixmaps
rmdir $INSTALLDIR/usr

mkdir -p $INSTALLDIR/lib/icons/hicolor/scalable/apps
cp $INSTALLDIR/lib/thinlinc/lib/tlclient/tlclient.svg \
	$INSTALLDIR/lib/icons/hicolor/scalable/apps/thinlinc.svg
icon-gen thinlinc

sed -i -e 's/needs="x11";/needs="x11"; menu="Connectivity";/g' $INSTALLDIR/lib/menu/thinlinc
sed -i -e 's/ \[fs\]//g' $INSTALLDIR/lib/menu/thinlinc

mv $INSTALLDIR/lib/thinlinc/lib/tlclient/pulseaudio $INSTALLDIR/lib/thinlinc/lib/tlclient/pulseaudio.orig

cat <<'EOF' > $INSTALLDIR/lib/thinlinc/lib/tlclient/pulseaudio
#!/bin/sh
unset LD_LIBRARY_PATH
/usr/bin/pulseaudio --kill
exec /usr/bin/pulseaudio -n --use-pid-file=false -L module-udev-detect -L "'$4'"  --log-level=info
EOF

chmod a+x $INSTALLDIR/lib/thinlinc/lib/tlclient/pulseaudio

cat << 'PATCH' > $INSTALLDIR/etc/init.d/patch.homedir
--- thinlinc.init~	2016-01-20 15:49:01.621723999 +0000
+++ thinlinc.init	2016-01-20 15:54:38.737723999 +0000
@@ -9,6 +9,8 @@
 case "$1" in 
 init)
 
+  HOME=/etc/skel
+  
   # If the file already exists, it was probably downloaded by
   # /etc/init.d/network on Thinstation 2.2 or later. 
   #
PATCH

( cd $INSTALLDIR/etc/init.d ; patch -p0 < patch.homedir )
rm $INSTALLDIR/etc/init.d/patch.homedir

echo -e "base\n" > $INSTALLDIR/dependencies
echo -e "pulseaudio\n" >> $INSTALLDIR/dependencies


exit $returnval
